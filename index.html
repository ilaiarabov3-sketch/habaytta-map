<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Habaytta — Real Map + Projects</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{ --bg:#e9e2db; --ink:#3a3330; --accent:#6c5a4d; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); }
  body { font-family: "Cormorant Garamond","Georgia","Times New Roman",serif; }
  .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
  .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .title{ font-size:18px; letter-spacing:.18em; color:var(--accent); text-transform:uppercase; border-bottom:1px solid var(--accent); padding-bottom:4px; }
  #map{ height:78vh; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden; position:relative; }
  .leaflet-container{ background:transparent; }
  .leaflet-control-attribution{ display:none; }
  .dot-proj{ width:7px; height:7px; border:2px solid var(--ink); border-radius:50%; background:transparent; }
  .hit{ width:28px; height:28px; border-radius:50%; background:rgba(0,0,0,0); }
  .city-label,.proj-label{ font-size:11px; letter-spacing:.06em; color:#3a3330; white-space:nowrap; pointer-events:none; }
  .pid{
    position:fixed; top:10vh; right:2vw; width: 420px; min-width: 360px; max-width: 560px;
    background:#ffffffcc; backdrop-filter: blur(3px);
    border:1px solid #e6e0d9; border-radius:14px; overflow:hidden; box-shadow:0 12px 40px rgba(0,0,0,.12);
    display:none; opacity:0; transform:translateY(8px); transition: opacity .22s ease, transform .22s ease; z-index: 1000;
  }
  .pid.show{ display:block; opacity:1; transform:translateY(0); }
  .pid-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #eadfd6; }
  .pid-title{ font-size:14px; letter-spacing:.12em; }
  .pid-close{ cursor:pointer; border:1px solid #cdbfb3; background:#fff; border-radius:8px; padding:4px 8px; font-size:12px; }
  .pid-body{ display:flex; gap:0; }
  .pid-img{ width:50%; aspect-ratio:4/3; object-fit:cover; border-left:1px solid #eadfd6; }
  .pid-meta{ width:50%; padding:10px 12px; font-size:13px; line-height:1.45; }
  .pid-meta .row{ display:grid; grid-template-columns: 110px 1fr; column-gap:12px; row-gap:2px; margin:6px 0; }
  .pid-meta .lbl{ opacity:.75; white-space:nowrap; }
  .pid-meta .val{ font-weight:500; overflow-wrap:anywhere; word-break:break-word; white-space:normal; }
  .pois-panel{
    position:absolute; left:16px; top:160px; z-index:1200;
    background:#ffffffcc; backdrop-filter:blur(4px);
    border:1px solid #e6e0d9; border-radius:12px; padding:10px;
    display:flex; flex-direction:column; gap:10px; width: 220px; pointer-events:auto;
  }
  .pois-title{ font-size:12px; letter-spacing:.08em; color:var(--accent); text-transform:uppercase; border-bottom:1px solid #eadfd6; padding-bottom:6px; }
  .section{ display:flex; flex-direction:column; gap:6px; }
  .feat-btn{ font-size:13px; padding:8px 10px; border-radius:10px; border:1px solid #cdbfb3; background:#fff; cursor:pointer; text-align:left; }
  .feat-btn.active{ background:#f3ece6; border-color:#b49f8f; }
  .pois-msg{ font-size:12px; color:#503a2b; background:#fff7ef; border:1px solid #e8d8c9; padding:6px 8px; border-radius:8px; display:none; }
  .pois-hint{ font-size:12px; opacity:.8; display:none; }
  .leaflet-div-icon.poi-bw { background:transparent; border:none; }
  .poi-bw svg{ width:24px; height:24px; stroke:#111; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; filter: drop-shadow(0 1px 0 rgba(0,0,0,.12)); }
  .pop-enter{ animation: poi-pop .42s cubic-bezier(.16,.84,.44,1); }
  @keyframes poi-pop{ 0%{transform:translateY(-6px) scale(.7); opacity:0;} 60%{transform:translateY(0) scale(1.05); opacity:1;} 100%{transform:translateY(0) scale(1); opacity:1; } }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">PROJECTS</div>
    <div style="font-size:12px; opacity:.8">Click a city → zoom 14; then click a small dot to open the project card</div>
  </div>
  <div id="map"></div>
  <div class="pois-panel" id="poisPanel" aria-label="Nearby places filters">
    <div class="pois-title">Nearby</div>
    <div class="section"><button class="feat-btn" data-cat="pray" title="Synagogues nearby">Pray</button></div>
    <div class="pois-msg" id="poisMsg"></div>
    <div class="pois-hint" id="poisHint">Click a project first</div>
  </div>
</div>

<div class="pid" id="pid" aria-hidden="true">
  <div class="pid-head">
    <div class="pid-title" id="pidTitle">—</div>
    <button class="pid-close" id="pidClose">Close</button>
  </div>
  <div class="pid-body">
    <img class="pid-img" id="pidImg" alt="Project image"/>
    <div class="pid-meta">
      <div class="row"><div class="lbl">City</div><div class="val" id="pidCity">—</div></div>
      <div class="row"><div class="lbl">Area</div><div class="val" id="pidArea">—</div></div>
      <div class="row"><div class="lbl">Price / sqm</div><div class="val" id="pidPpsm">—</div></div>
      <div class="row"><div class="lbl">Developer</div><div class="val" id="pidDev">—</div></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DATA = {
  cities: [
    { id:'savion', name:'Savion', lat:32.052, lng:34.873, zoom:14 },
    { id:'tel-aviv', name:'Tel Aviv', lat:32.0853, lng:34.7818, zoom:12 },
    { id:'jerusalem', name:'Jerusalem', lat:31.7683, lng:35.2137, zoom:12 }
  ],
  projects: [] // will load from projects.json
};

const map = L.map('map', { zoomControl:true }).setView([31.5, 34.9], 8);
window.__HABAYTTA_MAP__ = map;

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: ''
}).addTo(map);

const cityLayer = L.layerGroup().addTo(map);
for (const c of DATA.cities){
  const marker = L.circleMarker([c.lat,c.lng], { radius:6, color:'#3a3330', weight:2, fill:false });
  marker.addTo(cityLayer).bindTooltip(`<div class="city-label">${c.name}</div>`, {permanent:true, offset:[0,-12], direction:'top'});
  marker.on('click', () => map.setView([c.lat,c.lng], c.zoom || 14));
}

const projectLayer = L.layerGroup().addTo(map);

const pid = document.getElementById('pid');
const pidTitle = document.getElementById('pidTitle');
const pidImg = document.getElementById('pidImg');
const pidCity = document.getElementById('pidCity');
const pidArea = document.getElementById('pidArea');
const pidPpsm = document.getElementById('pidPpsm');
const pidDev = document.getElementById('pidDev');
document.getElementById('pidClose').addEventListener('click', () => pid.classList.remove('show'));

function openPID(p){
  pidTitle.textContent = p.name;
  pidImg.src = p.image;
  pidCity.textContent = p.city || '—';
  pidArea.textContent = p.area || '—';
  pidPpsm.textContent = p.price || p.pricePerSqm || '—';
  pidDev.textContent = p.developer || '—';
  pid.classList.add('show');
}

async function loadProjects(){
  try{
    const res = await fetch('./projects.json', {cache:'no-store'});
    const items = await res.json();
    DATA.projects = Array.isArray(items) ? items : [];
    renderProjects();
  }catch(e){
    console.error('Failed to load projects.json', e);
  }
}

function renderProjects(){
  projectLayer.clearLayers();
  for (const p of DATA.projects){
    if (!(p.lat && p.lng)) continue;
    const icon = L.divIcon({ className:'dot-proj', html:'' });
    const hit = L.divIcon({ className:'hit', html:'' });
    const m = L.marker([p.lat,p.lng], { icon: icon }).addTo(projectLayer);
    const h = L.marker([p.lat,p.lng], { icon: hit }).addTo(projectLayer);
    h.on('click', () => openPID(p));
  }
}
loadProjects();

// POI: Pray (Synagogues), 3km
(function(){
  const prayBtn = document.querySelector('.feat-btn[data-cat="pray"]');
  const msgBox = document.getElementById('poisMsg');
  const hintBox = document.getElementById('poisHint');
  const radiusKm = 3;

  function projectByName(){
    const map = {};
    for (const p of DATA.projects) if (p && p.name) map[p.name.trim()] = {lat:p.lat, lng:p.lng, id:p.id};
    return map;
  }

  let selectedCenter = null;
  const obs = new MutationObserver(() => {
    const name = (pidTitle.textContent||'').trim();
    const pb = projectByName();
    if (name && pb[name]){
      selectedCenter = pb[name];
      if (hintBox) hintBox.style.display = 'none';
    }
  });
  obs.observe(pidTitle, {childList:true, characterData:true, subtree:true});

  const prayLayer = L.layerGroup().addTo(window.__HABAYTTA_MAP__);

  function svgStarOfDavid(){
    return '<svg viewBox="0 0 24 24" aria-label="Synagogue">'+
           '<path d="M12 3 L4 17 L20 17 Z" />'+
           '<path d="M12 21 L4 7 L20 7 Z" />'+
           '</svg>';
  }
  function makeIcon(){
    return L.divIcon({ className:'poi-bw pop-enter', html: svgStarOfDavid(), iconSize:[24,24], iconAnchor:[12,12] });
  }

  async function fetchSynagogues(center, radiusMeters){
    const q = `[out:json][timeout:25];
      ( nwr(around:${radiusMeters},${center.lat},${center.lng})["amenity"="place_of_worship"]["religion"="jewish"];
        nwr(around:${radiusMeters},${center.lat},${center.lng})["amenity"="synagogue"]; );
      out center 100;`;
    const url = "https://overpass-api.de/api/interpreter";
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: "data=" + encodeURIComponent(q)
    });
    if (!res.ok) throw new Error("Overpass error " + res.status);
    return res.json();
  }

  function toLatLng(elem){
    if (elem.type === 'node') return {lat: elem.lat, lng: elem.lon};
    if (elem.type === 'way' || elem.type === 'relation'){
      const c = elem.center || {}; return (c.lat && c.lon) ? {lat:c.lat, lng:c.lon} : null;
    }
    return null;
  }
  function getName(tags){
    if (!tags) return 'Synagogue';
    return tags.name || tags["name:en"] || tags["name:he"] || tags["alt_name"] || 'Synagogue';
  }

  async function showPray(){
    if (!selectedCenter){
      if (hintBox){ hintBox.style.display='block'; }
      if (msgBox){ msgBox.style.display='none'; }
      return;
    }
    if (msgBox){ msgBox.textContent = 'Searching synagogues nearby…'; msgBox.style.display='block'; }
    prayLayer.clearLayers();
    try{
      const radMeters = Math.round(radiusKm * 1000);
      const data = await fetchSynagogues(selectedCenter, radMeters);
      const elems = (data && data.elements) ? data.elements : [];
      let count = 0;
      for (const e of elems){
        const ll = toLatLng(e); if (!ll) continue;
        const name = getName(e.tags);
        const m = L.marker(ll, {icon: makeIcon()});
        m.bindPopup(`<div style="font-size:13px"><b>${name}</b><br/>Synagogue</div>`);
        prayLayer.addLayer(m);
        count++;
      }
      if (msgBox){ msgBox.textContent = count ? `Found ${count} synagogues within ${radiusKm} km.` : 'No synagogues found in this area.'; }
    }catch(err){
      if (msgBox){ msgBox.textContent = 'Could not load synagogues right now.'; }
      console.error(err);
    }
  }

  if (prayBtn){
    prayBtn.addEventListener('click', () => {
      document.querySelectorAll('.feat-btn').forEach(b => b.classList.remove('active'));
      prayBtn.classList.add('active');
      showPray();
    }, {passive:true});
  }

  window.__HABAYTTA_POI_PRAY__ = { showPray, get selectedCenter(){return selectedCenter;}, layer: prayLayer };
})();
</script>
</body>
</html>
